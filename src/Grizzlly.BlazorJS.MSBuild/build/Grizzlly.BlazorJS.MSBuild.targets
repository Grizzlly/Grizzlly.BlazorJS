<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<ItemGroup>
		<VueComponents Include="src/**/*.vue" Condition="'@(VueComponents)' == ''" />
		<Content Include="@(VueComponents)" />
	</ItemGroup>

	<Target Name="CopyVueComponents" Inputs="@(VueComponents)" Outputs="@(VueComponents->'$(MSBuildThisFileDirectory)/src/%(RecursiveDir)%(Filename)%(Extension)')">
		<Copy SourceFiles="@(VueComponents)" DestinationFolder="$(MSBuildThisFileDirectory)/src" />
	</Target>
	<!-- See https://aka.ms/dotnet/msbuild/customize for more details on customizing your build -->
	<Target Name="BeforeResolveReferences" DependsOnTargets="CopyVueComponents">

		<Component Components="$(Components)" VueComponents="@(VueComponents)" ComponentsOut="$(MSBuildThisFileDirectory)/$(ComponentsFile)">
			<Output TaskParameter="ComponentsFileName" PropertyName="ComponentsOutputFile"/>
			<Output TaskParameter="PackagesList" PropertyName="NPMPackages" />
		</Component>
		<Exec Command="npm install $(NPMPackages)" WorkingDirectory="$(MSBuildThisFileDirectory)"/>
	</Target>

	<Target Name="vue-restore" BeforeTargets="vue-build">
		<Exec Command="npm install" WorkingDirectory="$(MSBuildThisFileDirectory)"/>
	</Target>

	<Target Name="vue-build" BeforeTargets="ResolveProjectStaticWebAssets">
		<Exec Command="npm run build" WorkingDirectory="$(MSBuildThisFileDirectory)" />
		<ItemGroup>
			<FilesToMove Include="$(MSBuildThisFileDirectory)\out\*"/>
		</ItemGroup>
		<!--<Message Text="Moving Files @(FilesToMove)"/>
		<Move SourceFiles="@(FilesToMove)" DestinationFolder="$(ComponentsOutDir)">
			<Output
			   TaskParameter="DestinationFiles"
			   ItemName="FilesWritten"/>
		</Move>
		<Message Text="@(FilesWritten)"/>-->
		<!--<StaticWebAsset Include="$([System.IO.Path]::GetFullPath($(MSBuildThisFileDirectory)\out\vuez.js))">
			<SourceType>Package</SourceType>
			<SourceId>Grizzlly.BlazorJS.MSBuild</SourceId>
			<ContentRoot>$(MSBuildThisFileDirectory)\out\</ContentRoot>
			<BasePath>_content/Grizzlly.BlazorJS.MSBuild</BasePath>
			<RelativePath>vuez.js</RelativePath>
			<AssetKind>All</AssetKind>
			<AssetMode>All</AssetMode>
			<AssetRole>Primary</AssetRole>
			<RelatedAsset></RelatedAsset>
			<AssetTraitName></AssetTraitName>
			<AssetTraitValue></AssetTraitValue>
			<CopyToOutputDirectory>Never</CopyToOutputDirectory>
			<CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
			<OriginalItemSpec>$([System.IO.Path]::GetFullPath($(MSBuildThisFileDirectory)\out\vuez.js))</OriginalItemSpec>
		</StaticWebAsset>-->

		<GetStaticWebAssets
		  Candidates="@(FilesToMove)"
		  SourceId="Grizzlly.BlazorJS.MSBuild"
		  Pattern="**/*"
		  ContentRoot="$(MSBuildThisFileDirectory)out\"
		  BasePath="_content/Grizzlly.BlazorJS.MSBuild"
		>
			<Output TaskParameter="DiscoveredStaticWebAssets" ItemName="StaticWebAsset" />
		</GetStaticWebAssets>

		<ItemGroup>
			<StaticWebAssetDiscoveryPattern Include="$(MSBuildThisFileDirectory)/out" Condition="Exists('$(MSBuildThisFileDirectory)/out')">
				<Source>Grizzlly.BlazorJS.MSBuild</Source>
				<BasePath>_content/Grizzlly.BlazorJS.MSBuild/</BasePath>
				<ContentRoot>$(MSBuildThisFileDirectory)out\</ContentRoot>
				<Pattern>**</Pattern>
			</StaticWebAssetDiscoveryPattern>
			<Content Remove="@(StaticWebAsset)" />
		</ItemGroup>
	</Target>

	<Target Name="vue-clean" AfterTargets="Clean" >
		<Exec Command="npm run clean" WorkingDirectory="$(MSBuildThisFileDirectory)" />
	</Target>
</Project>
